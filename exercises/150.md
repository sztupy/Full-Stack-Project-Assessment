# Level 150 - Week 1 - Frontend Deployment

By the end of this level you will have a React website that is available on the internet

## Fly.io

We will be using Fly.io to deploy your application. Fly.io is a cloud provider allowing you to run docker containers on virtual machines. They also provide a couple of tools to help you deploy applications, for example tools to automatically make applications compatible with Docker. They have a free tier available that allows you to run two machines - one machine will host the database, the other the monorepo, e.g. both the frontend and the backend.

### Prerequisites

Fly.io's management tool only works on networks which have IPv6 properly set up. Please check https://test-ipv6.com/ to make sure you have everything in order (but please note even getting a 10/10 score might mean you have issues).

Most notably as of 2023 BT and EE do not provide working IPv6 interfaces for consumers, and most public networks are also only only available on IPv4!

### Install flyctl

Fly.io relies on a command line utility to launch and deploy applications. You need to download and install it. You can find installation instructions here: https://fly.io/docs/hands-on/install-flyctl/

After installing you might need to close your terminal and reopen it to be able to access `flyctl`

### Signing up

To sign up for a fly.io account go to their sign up page at https://fly.io/app/sign-up Make sure you register using the "Sign up using GitHub", as otherwise you won't get added to the Trial package!

Once signed up you need to log in locally. Type in the following on your terminal then follow the instructions:

```
flyctl auth login
```

### Application setup

Once signed up you can now launch your application. Go to the root of your project and type

```
flyctl launch
```

Once you enter this command it will provide you with a prompt like the following:

```
We're about to launch your NodeJS app on Fly.io. Here's what you're getting:

Organization: test@codeyourfuture.io        (fly launch defaults to the personal org)
Name:         full-stack-project-assessment (derived from your directory name)
Region:       Amsterdam, Netherlands        (this is the fastest region for you)
App Machines: shared-cpu-1x, 1GB RAM        (most apps need about 1GB of RAM)
Postgres:     <none>                        (not requested)
Redis:        <none>                        (not requested)

? Do you want to tweak these settings before proceeding? (Y/n)
```

Make sure you enter `Y` on the prompt as the default settings are not going to use the free tier!

Once you enter `Y` and press enter you will be redirected to a website where you need to fill in the details as follows:

* Name: Use `YOURNAME-videorec`, example `john-smith-videorec`
* Region: Pick `lhr - London`.
* VM size: Pick `shared-cpu-1x`. Anything else is not included in the free tier!
* VM memory: Pick `256Mb`. Anything else is not included in the free tier!
* Databse: `Fly Postgres`
* DB Name: `YOURNAME-videorec-db`, example: `john-smith-videorec-db`
* Configuration: `Development - Single Node`. Anything else here is not included in the free tier!
* Redis: `None`

Once you fill in the details click "Confirm Settings"

This will set up your database and a machine for running your backend. If everything is successful you should get something like:

```
Now: run 'flyctl deploy' to deploy your Node app.
```

If the command however fails, it is possible that your network does not support IPv6. Please see the notes above around prerequisites!

Once everything is in order you can see that new files have been added by `fly launch` to your repository. These include a `Dockerfile` and a fly settings file called `fly.toml`. Make sure you commit both into your git repository, they will be needed during further deployments!

### Application deployment

Once you have initialized your fly environment you also need to deploy your application. First run the below command:

```
flyctl scale count 1
```

This is needed, because by default flyctl will start up your backend on two machines, however the trial tier of fly only support a total on two machines, and one of them is already used up by the database. This command tells flyctl that one machine for the backend will be enough.

Finally you are now ready for deployment:

```
flyctl deploy
```

This command will send your current repository to fly, build a docker image of your code then deploy that image to the Fly.io infrastructure.

If everything goes well your application will be available on

```
https://YOURNAME-videorec.fly.dev
```

Make sure to check that it works as expected!

### Automated Deployments

Note that fly.io doesn't have access to your GitHub account so it will not deploy your application whenever it changes. Either you need to run `fly deploy` from your computer every time you want to push a change, or you need to set up GitHub to do this for you.

In order to do this there are two steps: You need to give GitHub access to your fly.io account, and then also need to set up a workflow that runs the deploy command every time you push changes to the `main` branch.

For the first one you need to run the following command:

```
flyctl tokens create deploy -x 999999h
```

This will create a token that can be used by flyctl to run deployments. Make sure you save the result as you will need it later. It looks like a very-very long string starting with something like `FlyV1 fm2_lJPECAAAAAAAA...`.

Next go to your GitHub repository on GitHub, and click Settings. On the left hand side scroll down to "Secrets and variables" and select "Actions". One the page that shows up scroll down to "Repository secrets", and click "New repository secret"

Set the Name to `FLY_API_TOKEN` and the value to the full results of the previous call.

Now you have given GitHub access to your fly.io account. You also need to let GitHub know that you want to run a deployment every time your `main` branch changes. We have prepared a GitHub workflow for you in the `.github/workflows/fly-deploy.yml` file. Open it up and uncomment the line starting with `main`. Once you commit this file and push it to your `main` branch, GitHub will autoamtically run `flyctl deploy` against whatever is in your directory.
